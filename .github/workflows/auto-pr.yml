name: Auto Create PR

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    # Only run if PR doesn't already exist
    if: github.event_name == 'push'

    steps:
    - name: Check if PR exists
      id: check_pr
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pulls } = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
            state: 'open'
          });

          if (pulls.length > 0) {
            console.log(`PR already exists: ${pulls[0].html_url}`);
            core.setOutput('exists', 'true');
            core.setOutput('pr_number', pulls[0].number);
            core.setOutput('pr_url', pulls[0].html_url);
          } else {
            core.setOutput('exists', 'false');
          }

    - name: Create Pull Request
      if: steps.check_pr.outputs.exists == 'false'
      id: create_pr
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = context.ref.replace('refs/heads/', '');

          // Determine base branch (default to main)
          const baseBranch = 'main';

          // Generate PR title from branch name
          let title = branchName.replace('claude/', '').replace(/-[a-zA-Z0-9]{20,}$/, '');
          title = title.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

          // Get recent commits for context
          const { data: commits } = await github.rest.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: branchName,
            per_page: 5
          });

          // Build PR body from commits
          let body = `## Summary\n\nAuto-generated PR from branch: \`${branchName}\`\n\n`;
          body += `## Recent Commits\n\n`;
          commits.forEach(commit => {
            const message = commit.commit.message.split('\n')[0];
            body += `- ${message} (${commit.sha.substring(0, 7)})\n`;
          });
          body += `\n## Auto-Merge\n\nThis PR is configured to auto-merge when all checks pass.\n`;

          // Create the PR
          const { data: pr } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            head: branchName,
            base: baseBranch,
            body: body
          });

          console.log(`PR created: ${pr.html_url}`);
          core.setOutput('pr_number', pr.number);
          core.setOutput('pr_url', pr.html_url);

          return pr.number;

    - name: Enable Auto-Merge
      if: steps.check_pr.outputs.exists == 'false' && steps.create_pr.outputs.pr_number
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.create_pr.outputs.pr_number }};

          try {
            // Enable auto-merge with squash method
            await github.graphql(`
              mutation EnableAutoMerge($pullRequestId: ID!) {
                enablePullRequestAutoMerge(input: {
                  pullRequestId: $pullRequestId,
                  mergeMethod: SQUASH
                }) {
                  pullRequest {
                    autoMergeRequest {
                      enabledAt
                    }
                  }
                }
              }
            `, {
              pullRequestId: context.payload.pull_request.node_id
            });

            console.log(`Auto-merge enabled for PR #${prNumber}`);
          } catch (error) {
            console.log(`Could not enable auto-merge: ${error.message}`);
            console.log('You may need to enable it manually or check branch protection rules');
          }

    - name: Add Labels
      if: steps.check_pr.outputs.exists == 'false' && steps.create_pr.outputs.pr_number
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          const prNumber = ${{ steps.create_pr.outputs.pr_number }};

          await github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            labels: ['automated', 'claude-generated']
          });

    - name: Comment on PR
      if: steps.check_pr.outputs.exists == 'false' && steps.create_pr.outputs.pr_number
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = ${{ steps.create_pr.outputs.pr_number }};

          const comment = `ðŸ¤– **Auto-generated PR**

This pull request was automatically created by the Auto PR workflow.

**Configuration:**
- Base branch: \`main\`
- Auto-merge: Enabled (squash method)
- Branch will be deleted automatically after merge

**Next Steps:**
1. âœ… CI checks will run automatically
2. âœ… PR will auto-merge when all checks pass
3. âœ… Branch will be auto-deleted

No manual intervention required! ðŸŽ‰`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: comment
          });

    - name: Output PR Info
      run: |
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          echo "âœ… PR already exists: ${{ steps.check_pr.outputs.pr_url }}"
        else
          echo "âœ… PR created: ${{ steps.create_pr.outputs.pr_url }}"
          echo "âœ… Auto-merge: Enabled"
          echo "âœ… Will merge automatically when CI passes"
        fi
